---
title: "Calculating fx"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/n/janson_lab/lab/sma/sparsedossa_update/")
knitr::opts_chunk$set(echo=FALSE)
library(magrittr)
library(ggplot2)
```

## Notations

* $G \sim f_G(g | \Omega)$

* $F_{A_j}(A_j) = F_{G_j}(G_j)$
    
    * $F_{A_j}(a) = 0$ for $a < 0$, $F_{A_j}(a) = \pi_{0j}$ for $a = 0$, 
      $f_{\log A_j}(\log a) = (1 - \pi_{0j}) \times 
       \phi(\log a | \mu_j, \sigma_j)$ for $a > 0$
  
* $A_s = \sum A_j$, $X = A / A_s$

* For $A = (A_1, A_2)$, let $A_1$ be all zeros and $A_2$ non-zeros. 
  $G = (G_1, G_2) = (G_1(A_1), G_2(A_2))$ be the corresponding hidden variables.
  \begin{aligned}
    f_X(x) &= \int f_{(X, \log A_s)}(x, \log a_s) d \log a_s \\
           &= \int f_{A_1, \log A_2}(\log a_2) \times \frac{1}{\prod x_{2j}} 
              d \log a_s \\
           &= \int \left[\int_{- \inf}^{F^{-1}_{G_1}(\pi_{01})} 
                              f_G(g_1, g_2(\log a_2)) \times
                              \prod \frac{f_{\log A_{2j}}(\log a_{2j})}{f_{G_{2j}}(g_{2j})} 
                              d g_1\right] 
              \times \frac{1}{\prod x_{2j}} d \log a_s \\
           &= \int \left[\int_{- \inf}^{F^{-1}_{G_1}(\pi_{01})} 
                               f_G(g_1, g_2(\log a_2)) d g_1 \times
                               \prod \frac{f_{\log A{_2j}}(\log a_{2j})}{f_{G_{2j}}(g_{2j})}
                         \right] 
              \times \frac{1}{\prod x_{2j}} d \log a_s
  \end{aligned}
  
    * $\int_{- \inf}^{F^{-1}_{G_1}(\pi_{01})} f_G(g_1, g_2(\log a_2)) d g_1$ can
      be evaluated via `mvtnorm::pmvnorm`
    
    * Previous approach:
      $\int_{- \inf}^{F^{-1}_{G_1}(\pi_{01})} f_G(g_1, g_2(\log a_2)) d g_1 
       \propto f_G(g_1^*, g_2(\log a_2))$
       
## Compare against approximation

  * Want to ensure that new implementation is correct (generates proper density)
  
  * Validate this by checking that 
    $\int \left[\int_{- \inf}^{F^{-1}_{G_1}(\pi_{01})} 
                               f_G(g_1, g_2(\log a_2)) d g_1 \times
                               \prod \frac{f_{\log A_{2j}}(\log a_{2j})}{f_{G_{2j}}(g_{2j})}
                         \right] d \log a_2 = F_{G_1}(F^{-1}_{G_1}(\pi_{01}))$ 
  * $p = 4$, $\pi_0 = 1/2$, $\mu, \sigma$ standard normal, 
    $\sigma_{i, j} = 0.3$.

```{r evaluate for real data}
smar::sourceDir("SparseDOSSA2/R/")
load("results/Simulation_smaller/tb_job.RData")
i_tb_job <- tb_job %>% 
  dplyr::filter(dataset == "stool") %>% 
  dplyr::slice(1)
params_subset <- sapply(
  i_tb_job$params[[1]]$mu,
  function(i_mu) {
    i_mu %in% i_tb_job$params_sim[[1]]$mu
  }
)

params <- i_tb_job$params_sim[[1]]
x_samples <- i_tb_job$x_samples[[1]][1:5, ]
a_samples <- i_tb_job$a_samples[[1]][1:5, ]

log_asums <- seq(-5, 5, by = 0.5)
# compare dloga, fixing parameters
d1s <- sapply(1:nrow(x_samples),
              function(i_sample) {
                sapply(log_asums, function(i_logasum)
                  dloga_true(a = a(x = x_samples[i_sample, ],
                                   asum = exp(i_logasum)),
                             pi0 = params$pi0, 
                             mu = params$mu,
                             sigma = params$sigma,
                             Sigma = params$Sigma,
                             Omega = params$Omega)) 
              })
d2s_forInt <- future.apply::future_sapply(
  1:nrow(x_samples),
  function(i_sample) {
    m_cond <- mloga(a = x_samples[i_sample, ],
                    pi0 = params$pi0,
                    mu = params$mu,
                    sigma = params$sigma,
                    Sigma = params$Sigma)
    sapply(
      log_asums, 
      function(i_logasum)
        dloga_forInt(a = a(x = x_samples[i_sample, ],
                           asum = exp(i_logasum)),
                     pi0 = params$pi0, 
                     mu = params$mu,
                     sigma = params$sigma,
                     Sigma = params$Sigma,
                     Omega = params$Omega,
                     mean_cond = m_cond$mean_cond,
                     Sigma_cond = m_cond$Sigma_cond))
  })
p2s <- sapply(1:nrow(x_samples),
              function(i_sample)
                ploga(a = x_samples[i_sample, ],
                      pi0 = params$pi0, 
                      mu = params$mu,
                      sigma = params$sigma,
                      Sigma = params$Sigma))
d2s <- t(t(d2s_forInt) + p2s)

colnames(d1s) <- colnames(d2s) <- paste0("Sample", 1:5)
rbind(data.frame(log_asum = log_asums,
                 d1s,
                 method = "Original"),
      data.frame(log_asum = log_asums,
                 d2s,
                 method = "Approximate")) %>% 
  tidyr::pivot_longer(cols = Sample1:Sample5,
                      names_to = "Sample",
                      values_to = "logLik") %>% 
  ggplot(aes(x = log_asum,
             y = logLik,
             color = method)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Sample, scales = "free_y")


# compare dloga, fixing as
load("results/Stool_vaginal/tb_job.RData")
tb_params <- tb_job %>% 
  dplyr::filter(penalize_method == "huge",
                dataset == "stool",
                lambdas > 1e-2)
l_params <- tb_params$i_job %>% 
  purrr::map(~ {
    load(paste0("results/Stool_vaginal/fit_", .x, ".RData"))
    fit_EM$l_fits_full[[1]]$fit
  })
d1s <- sapply(1,
              function(i_sample) {
                sapply(l_params, function(i_params)
                  dloga_true(a = a_samples[i_sample, ],
                             pi0 = params$pi0, 
                             mu = params$mu,
                             sigma = params$sigma,
                             Sigma = i_params$Sigma[params_subset, 
                                                    params_subset],
                             Omega = solve(i_params$Sigma[params_subset, 
                                                          params_subset]))) 
              })
l_m_cond <- lapply(
  1:nrow(a_samples),
  function(i_sample) {
    future.apply::future_lapply(
      l_params,
      function(i_params) {
        mloga(
          a = a_samples[i_sample, ],
          pi0 = params$pi0, 
          mu = params$mu,
          sigma = params$sigma,
          Sigma = i_params$Sigma[params_subset, 
                                 params_subset]
        )
      })
  })
d2s_forInt <- sapply(
  1,
  function(i_sample) {
    future.apply::future_sapply(
      l_params, 
      function(i_params) {
        m_cond <- mloga(
          a = a_samples[i_sample, ],
          pi0 = params$pi0, 
          mu = params$mu,
          sigma = params$sigma,
          Sigma = i_params$Sigma[params_subset, 
                                 params_subset]
        )
        dloga_forInt(
          a = a_samples[i_sample, ],
          pi0 = params$pi0, 
          mu = params$mu,
          sigma = params$sigma,
          Sigma = i_params$Sigma[params_subset, 
                                 params_subset],
          Omega = solve(i_params$Sigma[params_subset, 
                                       params_subset]),
          mean_cond = m_cond$mean_cond,
          Sigma_cond = m_cond$Sigma_cond)
      })
  })
p2s <- sapply(1,
              function(i_sample) {
                sapply(l_params, function(i_params)
                  ploga(a = a_samples[i_sample, ],
                        pi0 = params$pi0, 
                        mu = params$mu,
                        sigma = params$sigma,
                        Sigma = i_params$Sigma[params_subset, 
                                               params_subset])) 
              })
d2s <- d2s_forInt + p2s
colnames(d1s) <- colnames(d2s) <- paste0("Sample", 1)
rbind(data.frame(lambdas = tb_params$lambdas,
                 d1s,
                 method = "Original"),
      data.frame(lambdas = tb_params$lambdas,
                 d2s,
                 method = "Approximate")) %>% 
  tidyr::pivot_longer(cols = Sample1,
                      names_to = "Sample",
                      values_to = "logLik") %>% 
  ggplot(aes(x = log10(lambdas),
             y = logLik,
             color = method)) +
  geom_point() +
  geom_line() +
  facet_grid(.~Sample)
```

```{r test}
ds <- sapply(log_asums, function(i_logasum)
  dloga_true(a = a(x = x_samples[1, ],
                   asum = exp(i_logasum)),
             pi0 = params$pi0, 
             mu = params$mu,
             sigma = params$sigma,
             Sigma = params$Sigma,
             Omega = params$Omega)) 
coef_lm <- lm(ds ~ log_asums + I(log_asums^2))$coef
mu <- - coef_lm[2] / coef_lm[3] / 2
sigma <- sqrt(- 1 / coef_lm[3] / 2)
system.time(
  test <- integrate(
    f = function(x) 
      sapply(x, function(xx) 
        dloga_true(a = a(x = x_samples[1, ],
                         asum = exp(xx)),
                   pi0 = params$pi0,
                   mu = params$mu,
                   sigma = params$sigma,
                   Sigma = params$Sigma,
                   Omega = params$Omega,
                   log.p = FALSE)),
    lower = mu - sigma * 3,
    upper = mu + sigma * 3,
    rel.tol = 1e-3,
    abs.tol = 0
  ))

time1 <- system.time(
  test1 <- integrate(
    f = function(x) 
      sapply(x, function(xx) 
        dloga_true(a = a(x = x_samples[1, ],
                         asum = exp(xx)),
                   pi0 = params$pi0,
                   mu = params$mu,
                   sigma = params$sigma,
                   Sigma = params$Sigma,
                   Omega = params$Omega,
                   log.p = FALSE)),
    lower = mu - 3 * sigma,
    upper = mu + 3 * sigma,
    rel.tol = 1e-3,
    abs.tol = 0
  ))

time0 <- system.time(
  test0 <- cubature::hcubature(
    f = function(x) 
      sapply(x, function(xx) 
        dloga_true(a = a(x = x_samples[1, ],
                         asum = exp(xx)),
                   pi0 = params$pi0,
                   mu = params$mu,
                   sigma = params$sigma,
                   Sigma = params$Sigma,
                   Omega = params$Omega,
                   log.p = FALSE)),
    lowerLimit = mu - 4 * sigma,
    upperLimit = mu + 4 * sigma,
    tol = 1e-3,
    absError = 0,
    maxEval = 10
  ))

time1 <- system.time(
  test1 <- cubature::hcubature(
    f = function(x) 
      sapply(x, function(xx) 
        dloga_true(a = a(x = x_samples[1, ],
                         asum = exp(xx)),
                   pi0 = params$pi0,
                   mu = params$mu,
                   sigma = params$sigma,
                   Sigma = params$Sigma,
                   Omega = params$Omega,
                   log.p = FALSE)),
    lowerLimit = mu - 4 * sigma,
    upperLimit = mu + 4 * sigma,
    tol = 1e-3,
    absError = 0,
    maxEval = 30
  ))

time2 <- system.time(
  test2 <- cubature::hcubature(
    f = function(x) 
      sapply(x, function(xx) 
        dloga_true(a = a(x = x_samples[1, ],
                         asum = exp(xx)),
                   pi0 = params$pi0,
                   mu = params$mu,
                   sigma = params$sigma,
                   Sigma = params$Sigma,
                   Omega = params$Omega,
                   log.p = FALSE)),
    lowerLimit = mu - 4 * sigma,
    upperLimit = mu + 4 * sigma,
    tol = 1e-3,
    absError = 0,
    maxEval = 100
  ))

time3 <- system.time(
  test3 <- integrate(
    f = function(x) 
      sapply(x, function(xx) 
        dloga_true(a = a(x = x_samples[1, ],
                         asum = exp(xx)),
                   pi0 = params$pi0,
                   mu = params$mu,
                   sigma = params$sigma,
                   Sigma = params$Sigma,
                   Omega = params$Omega,
                   log.p = FALSE)),
    lower = mu - 4 * sigma,
    upper = mu + 4 * sigma,
    rel.tol = 1e-3,
    abs.tol = 0
  ))

time2 <- system.time(
  test2 <- cubature::hcubature(
    f = function(x) 
      sapply(x, function(xx) 
        dloga_true(a = a(x = x_samples[1, ],
                         asum = exp(xx)),
                   pi0 = params$pi0,
                   mu = params$mu,
                   sigma = params$sigma,
                   Sigma = params$Sigma,
                   Omega = params$Omega,
                   log.p = FALSE)),
    lowerLimit = mu - 3 * sigma,
    upperLimit = mu + 3 * sigma,
    tol = 1e-3,
    absError = 0,
    maxEval = 100
  ))

offset <- dloga_true(a = a(x = x_samples[1, ],
                           asum = exp(mu)),
                     pi0 = params$pi0,
                     mu = params$mu,
                     sigma = params$sigma,
                     )
```