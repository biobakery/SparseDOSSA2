---
title: "Updated fitting and simulation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/n/janson_lab/lab/sma/sparsedossa_update/", echo=FALSE)
library(magrittr)
library(ggplot2)
```

## Outline

* On real data, CV glasso fits identify smallest $\lambda$ as optimal; ridge fits work for bigger $\lambda$ ranges, and also identify "dense" structure
* On simulated data with prescribed sparsity, glasso fits does find optimal $\lambda$

## Real data

* Results:

```{r real data, echo=FALSE, message=FALSE, warning=FALSE}
batchtools::loadRegistry(file.dir = "r_batchtools_reg/Stool_vaginal", writeable = FALSE)
dir_output <- "/n/janson_lab/lab/sma/sparsedossa_update/results/Stool_vaginal/"
tb_result <- tb_job %>% 
  dplyr::filter(i_job %in% batchtools::findDone()$job.id) %>% 
  dplyr::group_by(i_job) %>% 
  dplyr::mutate(fit_EM = 
                  {
                    load(paste0(dir_output, "fit_", i_job, ".RData"))
                    list(fit_EM)
                  }) %>% 
  dplyr::ungroup()
tb_result <- tb_result %>% 
  dplyr::arrange(lambdas) %>% 
  dplyr::mutate(log10_lambda = log10(lambdas) %>% 
                  format(digits = 2) %>% 
                  forcats::as_factor()) %>% 
  dplyr::group_by(i_job) %>% 
  dplyr::mutate(sparsity_Omega = fit_EM[[1]]$l_fits_full[[1]]$fit$Omega %>% 
                  SparseDOSSA2:::lower_tri() %>% {mean(. == 0)},
                sparsity_Sigma = fit_EM[[1]]$l_fits_full[[1]]$fit$Sigma %>% 
                  SparseDOSSA2:::lower_tri() %>% {mean(. == 0)},
                logLik_CV = mean(setdiff(fit_EM[[1]]$logLik_CV, -Inf)),
                logLik_CV_sd = sd(setdiff(fit_EM[[1]]$logLik_CV, -Inf)),
                logLik = fit_EM[[1]]$l_fits_full[[1]]$fit$logLik,
                no_error = fit_EM[[1]]$l_fits_full[[1]]$convergence$converge_code < 4) %>% 
  dplyr::ungroup()
tb_result %>% 
  dplyr::filter(no_error) %>% 
  tidyr::pivot_longer(cols = c(logLik_CV, logLik), names_to = "Class", values_to = "logLik") %>% 
  dplyr::mutate(sd = ifelse(Class == "logLik_CV",
                            logLik_CV_sd,
                            0)) %>% 
  ggplot(aes(x = log10(lambdas), y = logLik, color = Class)) +
  geom_point() +
  geom_errorbar(aes(alpha = Class, ymin = logLik - sd, ymax = logLik + sd),
                width = 0.02) +
  scale_alpha_manual(values = c("logLik_CV" = 1, "logLik" = 0), guide = FALSE) +
  facet_grid(dataset ~ penalize_method, scales = "free_y")
```

* Two different ridge penalties:
  
  * ridge1 = $\frac{1}{2}\lambda ||\Omega||_F^2 \Rightarrow \hat{\Omega}_\lambda = \left\{(\lambda I + \frac{1}{4}S)^{1/2} + \frac{1}{2}S\right\}^{-1}$
  
  * ridge2 = $\lambda \text{tr}(\Omega) \Rightarrow \hat{\Omega}_\lambda = (\lambda I + S)^{-1}$
  
  * Both penalize eigen values, give symmetric pd results
  
## Simulated data

* CV likelihood: these are glasso fitted results (no ridge)

```{r simulated, echo=FALSE, message=FALSE, warning=FALSE, fig.width=15}
batchtools::loadRegistry(file.dir = "r_batchtools_reg/Simulation_smaller/", writeable = FALSE)
dir_output <- "/n/janson_lab/lab/sma/sparsedossa_update/results/Simulation_smaller/"
load(paste0(dir_output, "tb_job_params_x.RData"))
tb_result <- tb_job_params_x %>% 
  dplyr::filter(i_job %in% batchtools::findDone()$job.id) %>% 
  dplyr::group_by(i_job) %>% 
  dplyr::mutate(fit_EM = 
                  {
                    load(paste0(dir_output, "fit_", i_job, ".RData"))
                    list(fit_EM)
                  }) %>% 
  dplyr::ungroup()
tb_result_formatted <- tb_result$fit_EM %>% 
  purrr::map2_dfr(tb_result$i_job,
                  ~ tibble::tibble(
                    i_job = .y,
                    result_fit_full = .x$l_fits_full,
                    logLik_CV = apply(.x$logLik_CV, 2, function(x) mean(setdiff(x, -Inf))),
                    no_error = result_fit_full %>% 
                      purrr::map_lgl(~.x$convergence$converge_code < 4)
                  )) %>% 
  dplyr::filter(no_error) %>% 
  dplyr::left_join(tb_result, by = "i_job") %>% 
  dplyr::mutate(
    lambda = result_fit_full %>% 
      purrr::map_dbl("lambda"),
    params_fit = 
      result_fit_full %>% 
      purrr::map("fit"),
    logLik = params_fit %>% 
      purrr::map("logLik"))
tb_result_formatted %>%
  ggplot(aes(x = log10(lambda), y = logLik_CV, color = as.character(R))) +
  geom_point() +
  geom_line() +
  facet_wrap(~ i_params + n, scales = "free_y", ncol = 3)
```

* Per-feature parameters: these are the induced x parameters

```{r parameters, echo=FALSE, message=FALSE, warning=FALSE, fig.width=15}
tb_result_top_CV <- tb_result_formatted %>%
  dplyr::group_by(i_job) %>%
  dplyr::arrange(-logLik_CV) %>%
  dplyr::slice(1) %>%
  dplyr::ungroup()
tb_result_top_CV <- tb_result_top_CV %>% 
  dplyr::group_by(i_job) %>% 
  dplyr::mutate(params_fit_x = {
    file <- paste0("params_fit_x_",
                   i_job,
                   ".RData")
    if(file %in% list.files(dir_output)) {
      load(paste0(dir_output, file))
      list(params_fit_x)
    } else list(NULL)
  }) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(!params_fit_x %>% purrr::map_lgl(is.null))

seq_len(nrow(tb_result_top_CV)) %>% 
  purrr::map_dfr(function(i_row) {
    tibble::tibble(i_job = tb_result_top_CV$i_job[i_row],
                   x_param = tb_result_top_CV$params_sim_x[[i_row]]$pi0,
                   x_fit_param = tb_result_top_CV$params_fit_x[[i_row]]$pi0)
  }) %>% 
  dplyr::left_join(tb_result_top_CV, by = "i_job") %>% 
  ggplot(aes(x = x_param, y = x_fit_param, color = as.character(R))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  ggpubr::stat_cor() +
  facet_wrap(~ i_params + n, ncol = 3) +
  ggtitle("x_pi0")

seq_len(nrow(tb_result_top_CV)) %>% 
  purrr::map_dfr(function(i_row) {
    tibble::tibble(i_job = tb_result_top_CV$i_job[i_row],
                   x_param = tb_result_top_CV$params_sim_x[[i_row]]$mu,
                   x_fit_param = tb_result_top_CV$params_fit_x[[i_row]]$mu)
  }) %>% 
  dplyr::left_join(tb_result_top_CV, by = "i_job") %>% 
  ggplot(aes(x = x_param, y = x_fit_param, color = as.character(R))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  ggpubr::stat_cor() +
  facet_wrap(~ i_params + n, ncol = 3) +
  ggtitle("x_mu")

seq_len(nrow(tb_result_top_CV)) %>% 
  purrr::map_dfr(function(i_row) {
    tibble::tibble(i_job = tb_result_top_CV$i_job[i_row],
                   x_param = tb_result_top_CV$params_sim_x[[i_row]]$sigma,
                   x_fit_param = tb_result_top_CV$params_fit_x[[i_row]]$sigma)
  }) %>% 
  dplyr::left_join(tb_result_top_CV, by = "i_job") %>% 
  ggplot(aes(x = x_param, y = x_fit_param, color = as.character(R))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  ggpubr::stat_cor() +
  facet_wrap(~ i_params + n, ncol = 3) +
  ggtitle("x_sigma")

seq_len(nrow(tb_result_top_CV)) %>% 
  purrr::map_dfr(function(i_row) {
    tibble::tibble(i_job = tb_result_top_CV$i_job[i_row],
                   x_param = tb_result_top_CV$params_sim_x[[i_row]]$Corr %>% lower_tri(),
                   x_fit_param = tb_result_top_CV$params_fit_x[[i_row]]$Corr %>% lower_tri())
  }) %>% 
  dplyr::left_join(tb_result_top_CV, by = "i_job") %>% 
  ggplot(aes(x = x_param, y = x_fit_param, color = as.character(R))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  ggpubr::stat_cor() +
  facet_wrap(~ i_params + n, ncol = 3) +
  ggtitle("x_Corr")
```