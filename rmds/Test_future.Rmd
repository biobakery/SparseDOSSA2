---
title: "Test future for more consistent implementation of parallelization"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
library(magrittr)
library(ggplot2)
```

```{r batch - multicore}
list(future.batchtools::batchtools_slurm %>% 
       future::tweak(resources = 
                       list(ncpus = 45,
                            partition = "janson_cascade",
                            walltime = 3600 * 24,
                            memory = 4048),
                     template = "slurm-simple"),
     future::multiprocess) %>% 
  future::plan()

time <- Sys.time()
for(i_job in 1) 
  test <- future::future({
    l_test <- list()
    for(i_step in 1:5) 
      l_test[[i_step]] <-
        future.apply::future_sapply(
          1:45,
          function(i_task) {
            Sys.sleep(0.5)
            paste(i_job,
                  Sys.info()["nodename"],
                  i_task,
                  Sys.getpid(), sep = ":")
          })
    l_test
  })
test <- future::value(test)
Sys.time() - time
```