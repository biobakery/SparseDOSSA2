---
title: "Calculating fx"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/n/janson_lab/lab/sma/sparsedossa_update/")
knitr::opts_chunk$set(echo=FALSE)
library(magrittr)
library(ggplot2)
```

## Notations

* $G \sim f_G(g | \Omega)$

* $F_{A_j}(A_j) = F_{G_j}(G_j)$
    
    * $F_{A_j}(a) = 0$ for $a < 0$, $F_{A_j}(a) = \pi_{0j}$ for $a = 0$, 
      $f_{\log A_j}(\log a) = (1 - \pi_{0j}) \times 
       \phi(\log a | \mu_j, \sigma_j)$ for $a > 0$
  
* $A_s = \sum A_j$, $X = A / A_s$

* For $A = (A_1, A_2)$, let $A_1$ be all zeros and $A_2$ non-zeros. 
  $G = (G_1, G_2) = (G_1(A_1), G_2(A_2))$ be the corresponding hidden variables.
  \begin{aligned}
    f_X(x) &= \int f_{(X, \log A_s)}(x, \log a_s) d \log a_s \\
           &= \int f_{A_1, \log A_2}(\log a_2) \times \frac{1}{\prod x_{2j}} 
              d \log a_s \\
           &= \int \left[\int_{- \inf}^{F^{-1}_{G_1}(\pi_{01})} 
                              f_G(g_1, g_2(\log a_2)) \times
                              \prod \frac{f_{\log A_{2j}}(\log a_{2j})}{f_{G_{2j}}(g_{2j})} 
                              d g_1\right] 
              \times \frac{1}{\prod x_{2j}} d \log a_s \\
           &= \int \left[\int_{- \inf}^{F^{-1}_{G_1}(\pi_{01})} 
                               f_G(g_1, g_2(\log a_2)) d g_1 \times
                               \prod \frac{f_{\log A{_2j}}(\log a_{2j})}{f_{G_{2j}}(g_{2j})}
                         \right] 
              \times \frac{1}{\prod x_{2j}} d \log a_s
  \end{aligned}
  
    * $\int_{- \inf}^{F^{-1}_{G_1}(\pi_{01})} f_G(g_1, g_2(\log a_2)) d g_1$ can
      be evaluated via `mvtnorm::pmvnorm`
    
    * Previous approach:
      $\int_{- \inf}^{F^{-1}_{G_1}(\pi_{01})} f_G(g_1, g_2(\log a_2)) d g_1 
       \propto f_G(g_1^*, g_2(\log a_2))$
       
## Unit testing

  * Want to ensure that new implementation is correct (generates proper density)
  
  * Validate this by checking that 
    $\int \left[\int_{- \inf}^{F^{-1}_{G_1}(\pi_{01})} 
                               f_G(g_1, g_2(\log a_2)) d g_1 \times
                               \prod \frac{f_{\log A_{2j}}(\log a_{2j})}{f_{G_{2j}}(g_{2j})}
                         \right] d \log a_2 = F_{G_1}(F^{-1}_{G_1}(\pi_{01}))$ 
  * $p = 4$, $\pi_0 = 1/2$, $\mu, \sigma$ standard normal, 
    $\sigma_{i, j} = 0.3$.

```{r evaluate for real data}
smar::sourceDir("SparseDOSSA2/R/")
load("results/Simulation_smaller/tb_job.RData")
i_tb_job <- tb_job %>% 
  dplyr::filter(dataset == "stool") %>% 
  dplyr::slice(1)
params_subset <- sapply(
  i_tb_job$params[[1]]$mu,
  function(i_mu) {
    i_mu %in% i_tb_job$params_sim[[1]]$mu
  }
)

params <- i_tb_job$params_sim[[1]]
x_samples <- i_tb_job$x_samples[[1]][1:5, ]
a_samples <- i_tb_job$a_samples[[1]][1:5, ]

log_asums <- seq(-5, 5, by = 0.5)
# compare dloga, fixing parameters
d1s <- sapply(1:nrow(x_samples),
              function(i_sample) {
                sapply(log_asums, function(i_logasum)
                  dloga(a = a(x = x_samples[i_sample, ],
                              asum = exp(i_logasum)),
                        pi0 = params$pi0, 
                        mu = params$mu,
                        sigma = params$sigma,
                        Sigma = params$Sigma,
                        Omega = params$Omega)) 
              })
d2s <- sapply(1:nrow(x_samples),
              function(i_sample) {
                sapply(log_asums, function(i_logasum)
                  dloga_old(a = a(x = x_samples[i_sample, ],
                                  asum = exp(i_logasum)),
                            pi0 = params$pi0, 
                            mu = params$mu,
                            sigma = params$sigma,
                            Omega = params$Omega))
              })
colnames(d1s) <- colnames(d2s) <- paste0("Sample", 1:5)
rbind(data.frame(log_asum = log_asums,
                 d1s,
                 method = "Original"),
      data.frame(log_asum = log_asums,
                 d2s,
                 method = "Approximate")) %>% 
  tidyr::pivot_longer(cols = Sample1:Sample5,
                      names_to = "Sample",
                      values_to = "logLik") %>% 
  ggplot(aes(x = log_asum,
             y = logLik,
             color = method)) +
  geom_point() +
  geom_line() +
  facet_grid(.~Sample)


# compare dloga, fixing as
load("results/Stool_vaginal/tb_job.RData")
tb_params <- tb_job %>% 
  dplyr::filter(penalize_method == "huge",
                dataset == "stool",
                lambdas > 1e-2)
l_params <- tb_params$i_job %>% 
  purrr::map(~ {
    load(paste0("results/Stool_vaginal/fit_", .x, ".RData"))
    fit_EM$l_fits_full[[1]]$fit
  })
d1s_params <- sapply(1:nrow(a_samples),
                     function(i_sample) {
                       sapply(l_params, function(i_params)
                         dloga(a = a_samples[i_sample, ],
                               pi0 = params$pi0, 
                               mu = params$mu,
                               sigma = params$sigma,
                               Sigma = i_params$Sigma[params_subset, 
                                                      params_subset],
                               Omega = solve(i_params$Sigma[params_subset, 
                                                            params_subset]))) 
                     })
d2s_params <- sapply(1:nrow(a_samples),
                     function(i_sample) {
                       sapply(l_params, function(i_params)
                         dloga_old(a = a_samples[i_sample, ],
                                   pi0 = params$pi0, 
                                   mu = params$mu,
                                   sigma = params$sigma,
                                   Omega = solve(i_params$Sigma[params_subset, 
                                                                params_subset])))
                     })

colnames(d1s_params) <- colnames(d2s_params) <- paste0("Sample", 1:5)
rbind(data.frame(lambdas = tb_params$lambdas,
                 d1s_params,
                 method = "Original"),
      data.frame(lambdas = tb_params$lambdas,
                 d2s_params,
                 method = "Approximate")) %>% 
  tidyr::pivot_longer(cols = Sample1:Sample5,
                      names_to = "Sample",
                      values_to = "logLik") %>% 
  ggplot(aes(x = log10(lambdas),
             y = logLik,
             color = method)) +
  geom_point() +
  geom_line() +
  facet_grid(.~Sample)
```