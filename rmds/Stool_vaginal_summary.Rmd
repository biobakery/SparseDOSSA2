---
title: "Summarize results of real-world dataset fitting"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/n/janson_lab/lab/sma/sparsedossa_update/")
library(magrittr)
library(ggplot2)
dir_output <- "/n/janson_lab/lab/sma/sparsedossa_update/results/Stool_vaginal/"
dir.create(dir_output, recursive = TRUE, showWarnings = FALSE)
```

```{r load results, include=FALSE}
batchtools::loadRegistry(file.dir = "r_batchtools_reg/Stool_vaginal", writeable = FALSE)
tb_result <- tb_job %>% 
  dplyr::group_by(i_job) %>% 
  dplyr::mutate(fit_EM = 
  {
    if(paste0("fit_", i_job, ".RData") %in% list.files(dir_output)) {
      load(paste0(dir_output, "fit_", i_job, ".RData"))
      list(fit_EM)
    } else {
      list(NULL)
    }
  }) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(fit_EM %>% 
                  purrr::map_lgl(~ !is.null(.x)))
```

Two datasets were fitted, from stool (more continuous) and vaginal (discretized by the dominant species) samples. For stool, $n=$ `r nrow(x_samples_stool)` and $p=$ `r ncol(x_samples_stool)`. For vaginal, $n=$ `r nrow(x_samples_vaginal)` and $p=$ `r ncol(x_samples_vaginal)`.

```{r format results}
tb_result <- tb_result %>% 
  dplyr::arrange(lambdas) %>% 
  dplyr::mutate(log10_lambda = log10(lambdas) %>% 
                  format(digits = 2) %>% 
                  forcats::as_factor()) %>% 
  dplyr::group_by(i_job) %>% 
  dplyr::mutate(sparsity_Omega = fit_EM[[1]]$l_fits_full[[1]]$fit$Omega %>% 
                  SparseDOSSA2:::lower_tri() %>% {mean(. == 0)},
                sparsity_Sigma = fit_EM[[1]]$l_fits_full[[1]]$fit$Sigma %>% 
                  SparseDOSSA2:::lower_tri() %>% {mean(. == 0)},
                logLik_CV = mean(setdiff(fit_EM[[1]]$logLik_CV, -Inf)),
                logLik_CV_sd = sd(setdiff(fit_EM[[1]]$logLik_CV, -Inf)),
                logLik = fit_EM[[1]]$l_fits_full[[1]]$fit$logLik) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(!is.na(logLik))
```
Main conclusion: graphical lasso and ridge estimators land at very similar "best" solution by cross validation likelihood.

# Examine fitted results



* Two different ridge penalties:
  * ridge1 = $\frac{1}{2}\lambda ||\Omega||_F^2 \Rightarrow \hat{\Omega}_\lambda = \left\{(\lambda I + \frac{1}{4}S)^{1/2} + \frac{1}{2}S\right\}^{-1}$
  * ridge2 = $\lambda \text{tr}(\Omega) \Rightarrow \hat{\Omega}_\lambda = (\lambda I + S)^{-1}$
* Both penalize eigen values, give symmetric pd results

```{r examine log likelihood and sparsity, echo=FALSE}
tb_result %>% 
  tidyr::pivot_longer(cols = c(logLik_CV, logLik), names_to = "Class", values_to = "logLik") %>% 
  dplyr::mutate(sd = ifelse(Class == "logLik_CV",
                            logLik_CV_sd,
                            0)) %>% 
  ggplot(aes(x = log10(lambdas), y = logLik, color = Class)) +
  geom_point() +
  geom_errorbar(aes(alpha = Class, ymin = logLik - sd, ymax = logLik + sd),
                width = 0.02) +
  scale_alpha_manual(values = c("logLik_CV" = 1, "logLik" = 0), guide = FALSE) +
  facet_grid(dataset ~ penalize_method, scales = "free_y")

# tb_result %>%
#   ggplot(aes(x = log10(lambda), y = sparsity_Omega)) +
#   geom_point() + geom_line() +
#   facet_grid(dataset ~ ., scales = "free_y")
# 
# tb_result %>%
#   ggplot(aes(x = log10(lambda), y = sparsity_Sigma)) +
#   geom_point() + geom_line() +
#   facet_grid(dataset ~ ., scales = "free_y")
# 
# plot(tb_result$sparsity_Omega, tb_result$sparsity_Sigma)
```

# Do these results give similar parameter estimations?
```{r compare fit, echo=FALSE}
tb_result_compare <- tb_result %>%
  dplyr::group_by(penalize_method, dataset) %>% 
  dplyr::arrange(-logLik_CV) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup()

tb_result_compare <- c("sigma", "Omega", "Sigma") %>% 
  purrr::map_dfr(
    function(i_param) 
      tb_result_compare$fit_EM %>% 
      purrr::map2_dfr(
        tb_result_compare$i_job,
        function(i_fit, i_job)
          tibble::tibble(
            param = i_param,
            i_job = i_job,
            values = {if(!(i_param %in% c("Omega", "Sigma")))
                i_fit$l_fits_full[[1]]$fit[[i_param]]
              else
                i_fit$l_fits_full[[1]]$fit[[i_param]] %>% 
                lower_tri()},
            i_feature = seq_along(values))
      )
  ) %>% 
  dplyr::left_join(tb_result_compare, by = "i_job")

tb_result_compare <- tb_result_compare %>% 
  tidyr::pivot_wider(id_cols = c(dataset, param, i_feature),
                     names_from = penalize_method,
                     values_from = values)

for(i_param in c("sigma", "Omega", "Sigma")) {
  p <- tb_result_compare %>% 
    dplyr::filter(param == i_param) %>% 
    ggplot(aes(x = huge, y = ridge1)) +
    geom_point() +
    geom_abline(intercept = 0, slope = 1) +
    ggpubr::stat_cor() +
    facet_wrap(.~dataset) +
    ggtitle(i_param) +
    coord_fixed()
  print(p)
}

for(i_param in c("sigma", "Omega", "Sigma")) {
  p <- tb_result_compare %>% 
    dplyr::filter(param == i_param) %>% 
    ggplot(aes(x = huge, y = ridge2)) +
    geom_point() +
    geom_abline(intercept = 0, slope = 1) +
    ggpubr::stat_cor() +
    facet_wrap(.~dataset) +
    ggtitle(i_param) +
    coord_fixed()
  print(p)
}
```