---
title: "12-02 meeting"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "../../")
library(magrittr)
library(ggplot2)
```

## Agenda
* Real data results
* The model
* Fitting
  * Identifiability
  * Algorithm
* Comparison against existing methods
* Strategize about paper 3 vs. CRT paper

## Real data results
```{r load data, include=FALSE}
load("data/physeqs/genera.RData")
physeq <- physeq_genera %>% 
  phyloseq::subset_samples(dataset_name == "MucosalIBD") %>% 
  smar::prune_taxaSamples(flist_taxa = genefilter::kOverA(k = 5, A = 1))
mat_X_count <- t(smar::otu_table2(physeq))
colnames(mat_X_count) <- CRTmicrobiome:::simplify_feature(colnames(mat_X_count))
mat_X <- t(apply(mat_X_count, 1, function(x) x / sum(x)))
```

```{r sample from estimated distributions, include=FALSE}
load("results/EM_diagnostics/mcmc.RData")
params <- fit_EM_mcmc$ll_params[[20]]
samples_A <- SparseDOSSA2:::rcopulasso(n = 10000,
                                       mean = params$mu,
                                       sd = params$sigma,
                                       pi0 = params$pi0,
                                       sigma = solve(params$Omega))
colnames(samples_A) <- colnames(mat_X)
rownames(samples_A) <- paste0("Sample", seq_len(10000))
samples_X <- t(apply(samples_A, 1, function(x) x / sum(x)))
```

* Stool marginals

```{r plotting, echo=FALSE}
features_order <- colnames(mat_X)[order(-apply(mat_X, 2, mean))]
matOTU_combined <- rbind(mat_X, samples_X[seq_len(nrow(mat_X)), ]) %>% 
  t()
dfMeta_combined <- 
  tibble::tibble(sample_name = c(rownames(mat_X),
                                 rownames(samples_X)[seq_len(nrow(mat_X))]),
                 Sample = rep(c("Original", "SparseDOSSA"),
                              each = nrow(mat_X)) %>% 
                   forcats::as_factor())
nFeatures_heatmap <- 20
tb_heatmap <- matOTU_combined %>% 
  `[`(features_order[seq_len(20)], ) %>% 
  {log10(. + 1e-5)} %>% 
  t() %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column("sample_name") %>% 
  dplyr::left_join(dfMeta_combined, by = "sample_name") %>% 
  dplyr::arrange(Sample, 
                 -!!sym(features_order[1]), -!!sym(features_order[2]),
                 -!!sym(features_order[3]), -!!sym(features_order[4]),
                 -!!sym(features_order[5]), -!!sym(features_order[6]),
                 -!!sym(features_order[7]), -!!sym(features_order[8])) %>% 
  dplyr::mutate(sample_name = sample_name %>% forcats::fct_inorder()) %>% 
  tidyr::gather(key = "feature", value = "Abundance", -sample_name, -Sample) %>% 
  dplyr::mutate(feature = factor(feature, levels = rev(features_order)))
tb_separate <- data.frame(x = nrow(mat_X),
                          y = -0.5,
                          yend = nFeatures_heatmap + 1.5)
p_heatmap <- tb_heatmap %>% 
  ggplot() +
  geom_tile(data = tb_heatmap, 
            aes(x = sample_name, y = feature,
                fill = Abundance)) +
  scale_fill_gradient(low = "black", high = "red", name = "log 10 abundance") +
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        legend.position = "top", legend.direction = "horizontal") +
  coord_cartesian(clip = 'off') +
  annotate("segment", 
           x = nrow(mat_X),
           xend = nrow(mat_X),
           y = 0.5,
           yend = nFeatures_heatmap + 0.5,
           size = 1, linetype = "dashed", color = "white") +
  annotate("text", x = nrow(mat_X), y = nFeatures_heatmap + 0.5,
           hjust = 1.1, vjust = 1.1, label = "Original", size = 5,
           color = "white") +
  annotate("text", x = nrow(mat_X), y = nFeatures_heatmap + 0.5,
           hjust = -0.1, vjust = 1.1, label = "SparseDOSSA", size = 5,
           color = "white")
print(p_heatmap)
```

* Stool feature-feature associations

```{r cors, echo=FALSE, fig.width=20, fig.height=10}
mat_X_filtered <- mat_X[, params$pi0 < 0.8]
features_topbottom <- c(colnames(mat_X_filtered)[order(-apply(mat_X_filtered, 2, mean))][1:10],
                        rev(colnames(mat_X_filtered)[order(apply(mat_X_filtered, 2, mean))][1:10]))

cor_data <- cor(mat_X, method = "spearman")[features_topbottom,
                                            features_topbottom]
cor_abs <- SparseDOSSA2:::Rho(solve(params$Omega))
dimnames(cor_abs) <- list(colnames(mat_X), colnames(mat_X))
cor_abs <- cor_abs[features_topbottom,
                   features_topbottom]
cor_samples <- cor(samples_X, method = "spearman")[features_topbottom,
                                                   features_topbottom]
samples_A_random <- apply(samples_A, 2, sample)
samples_X_random <- t(apply(samples_A_random, 1, function(x) x/sum(x)))
cor_samples_null <- cor(samples_X_random, method = "spearman")[features_topbottom,
                                                               features_topbottom]
p_cors <- list(cor_samples,
               cor_abs,
               cor_samples_null) %>% 
  purrr::map2_dfr(
    c("Estimated",
      "Biological",
      "Compositional"),
    function(mat_cor, association) {
      mat_cor %>% 
        SparseDOSSA2:::make_cortb() %>% 
        dplyr::mutate(feature1 = factor(feature1, levels = features_topbottom),
                      feature2 = factor(feature2, levels = features_topbottom)) %>% 
        dplyr::mutate(data = association)
    }) %>% 
  dplyr::mutate(data = factor(data,
                              levels = c("Observed",
                                         "Estimated",
                                         "Biological",
                                         "Compositional"))) %>% 
  ggplot(aes(x = feature2,
             y = feature1,
             fill = cor)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", 
                       limits = c(-0.5, 0.5),
                       na.value = "white") +
  smar::rotate_xaxis(90) +
  facet_grid(.~data) +
  theme(axis.title = element_blank(),
        legend.position = "bottom")
print(p_cors)
```

```{r load data vag, include=FALSE}
load("data/physeqs/HMP1II_vaginal.RData")
physeq <- physeq_vaginal %>% 
  smar::prune_taxaSamples(flist_taxa = genefilter::kOverA(k = 10, A = 2))
mat_X_count <- t(smar::otu_table2(physeq))
colnames(mat_X_count) <- CRTmicrobiome:::simplify_feature(colnames(mat_X_count))
mat_X <- t(apply(mat_X_count, 1, function(x) x / sum(x)))
```

```{r sample from estimated distributions vag, include=FALSE}
load("results/EM_diagnostics/vaginal_mcmc.RData")
params <- fit_EM_mcmc$ll_params[[20]]
samples_A <- SparseDOSSA2:::rcopulasso(n = 20000,
                                       mean = params$mu,
                                       sd = params$sigma,
                                       pi0 = params$pi0,
                                       sigma = solve(params$Omega))
samples_A <- samples_A[!apply(samples_A == 0, 1, all), ]
colnames(samples_A) <- colnames(mat_X)
rownames(samples_A) <- paste0("Sample", seq_len(nrow(samples_A)))
samples_X <- t(apply(samples_A, 1, function(x) x / sum(x)))
```

* Vaginal marginals

```{r plotting vag, echo=FALSE}
features_order <- colnames(mat_X)[order(-apply(mat_X, 2, mean))]
matOTU_combined <- rbind(mat_X, samples_X[seq_len(nrow(mat_X)), ]) %>% 
  t()
dfMeta_combined <- 
  tibble::tibble(sample_name = c(rownames(mat_X),
                                 rownames(samples_X)[seq_len(nrow(mat_X))]),
                 Sample = rep(c("Original", "SparseDOSSA"),
                              each = nrow(mat_X)) %>% 
                   forcats::as_factor())
nFeatures_heatmap <- 20
tb_heatmap <- matOTU_combined %>% 
  `[`(features_order[seq_len(20)], ) %>% 
  {log10(. + 1e-5)} %>% 
  t() %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column("sample_name") %>% 
  dplyr::left_join(dfMeta_combined, by = "sample_name") %>% 
  dplyr::arrange(Sample, 
                 -!!sym(features_order[1]), -!!sym(features_order[2]),
                 -!!sym(features_order[3]), -!!sym(features_order[4]),
                 -!!sym(features_order[5]), -!!sym(features_order[6]),
                 -!!sym(features_order[7]), -!!sym(features_order[8])) %>% 
  dplyr::mutate(sample_name = sample_name %>% forcats::fct_inorder()) %>% 
  tidyr::gather(key = "feature", value = "Abundance", -sample_name, -Sample) %>% 
  dplyr::mutate(feature = factor(feature, levels = rev(features_order)))
tb_separate <- data.frame(x = nrow(mat_X),
                          y = -0.5,
                          yend = nFeatures_heatmap + 1.5)
p_heatmap <- tb_heatmap %>% 
  ggplot() +
  geom_tile(data = tb_heatmap, 
            aes(x = sample_name, y = feature,
                fill = Abundance)) +
  scale_fill_gradient(low = "black", high = "red", name = "log 10 abundance") +
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        legend.position = "top", legend.direction = "horizontal") +
  coord_cartesian(clip = 'off') +
  annotate("segment", 
           x = nrow(mat_X),
           xend = nrow(mat_X),
           y = 0.5,
           yend = nFeatures_heatmap + 0.5,
           size = 1, linetype = "dashed", color = "white") +
  annotate("text", x = nrow(mat_X), y = nFeatures_heatmap + 0.5,
           hjust = 1.1, vjust = 1.1, label = "Original", size = 5,
           color = "white") +
  annotate("text", x = nrow(mat_X), y = nFeatures_heatmap + 0.5,
           hjust = -0.1, vjust = 1.1, label = "SparseDOSSA", size = 5,
           color = "white")
print(p_heatmap)
```

* Vaginal feature-feature associations

```{r cors vag, echo=FALSE, fig.width=12, fig.height=6}
features_topbottom <- colnames(mat_X)[order(-apply(mat_X, 2, mean))][1:10]
cor_data <- cor(mat_X, method = "spearman")[features_topbottom,
                                            features_topbottom]
cor_abs <- SparseDOSSA2:::Rho(solve(params$Omega))
dimnames(cor_abs) <- list(colnames(mat_X), colnames(mat_X))
cor_abs <- cor_abs[features_topbottom,
                   features_topbottom]
cor_samples <- cor(samples_X, method = "spearman")[features_topbottom,
                                                   features_topbottom]
samples_A_random <- apply(samples_A, 2, sample)
samples_A_random <- samples_A_random[!apply(samples_A_random == 0,
                                            1, all), ]
samples_X_random <- t(apply(samples_A_random, 1, function(x) x/sum(x)))
cor_samples_null <- cor(samples_X_random, method = "spearman")[features_topbottom,
                                                               features_topbottom]
p_cors <- list(cor_samples,
               cor_abs,
               cor_samples_null) %>% 
  purrr::map2_dfr(
    c("Estimated",
      "Biological",
      "Compositional"),
    function(mat_cor, association) {
      mat_cor %>% 
        SparseDOSSA2:::make_cortb() %>% 
        dplyr::mutate(feature1 = factor(feature1, levels = features_topbottom),
                      feature2 = factor(feature2, levels = features_topbottom)) %>% 
        dplyr::mutate(data = association)
    }) %>% 
  dplyr::mutate(data = factor(data,
                              levels = c("Observed",
                                         "Estimated",
                                         "Biological",
                                         "Compositional"))) %>% 
  ggplot(aes(x = feature2,
             y = feature1,
             fill = cor)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", 
                       limits = c(-0.5, 0.5),
                       na.value = "white") +
  smar::rotate_xaxis(90) +
  facet_grid(.~data) +
  theme(axis.title = element_blank(),
        legend.position = "bottom")
print(p_cors)
```

## The model
Let $a$ be unobserved absolute abundances and $x$ be relative abundances,
\begin{align}
f_{a}(a) 
&= \prod_j f_{a_j}(a_j) \times \frac{f_{a}(a)}{\prod_j f_{a_j}(a_j)} \\
&= \prod_j f_{a_j}(a_j) \times \frac{f_{g}(g)}{\prod_j f_{g_j}(g_j)} \\
&= \prod_j f_{a_j}(a_j | \mu_j, \sigma_j, \pi_{0j}) \times \frac{f_{g}(g | \Omega)}{\prod_j f_{g_j}(g_j)}
\end{align}

$f_{a_j}(a_j | \mu_j, \sigma_j, \pi_{0j}) \sim$ zero-inflated log normal. 
$f_g(g | \Omega) \sim$ MVN. $f_{g_j}(g_j) \sim$ standard normal.

Let $a^s = \sum_j a_j$. $x_j = a_j / a^s$,

\begin{align}
f_x(x) = \int f_a(a) (a^s)^{p - 1} da^s
\end{align}

## Fitting
* [Full write-up](https://www.dropbox.com/s/znfk3u9seis3dkk/new_model.html?dl=0)
* Identifiability
  * Can prove (under the case of no ZI):
    * $\mu$, $\Omega$ not identifiable;
    * $\pi_0$ identifiable, $\sigma_j$ identifiable given $\Omega$
* Algorithm
  * Identifiability of parameters leads to a penalized likelihood as objective 
    function. The minimization probelm is:
    
    \begin{align}
      -\log f_x(x | \hat{\mu}, \hat{\pi}_0, \sigma, \Omega) + \lambda ||\Omega||_1
    \end{align}
  * $\hat{\mu}, \hat{\pi}_0$ are directly estimated from $x$. For optimizing
    $\sigma$ and $\Omega$, can adopt standard EM procedure, with $a^s$ as the 
    E-step hidden parameter
  * E-step can either be achieved via MCMC (slow, solved) or 
    numerical integration (fast, unsolved)! 
    [Write-up](https://www.dropbox.com/s/n64epmhz3pavynk/smaller_data.html?dl=0).

## Comparison against existing methods
* [Full write-up](https://www.dropbox.com/s/38obuckxup7vs4j/adapt_ZIPFA.html?dl=0)
* To show validity of model, would like to compare against existing methods
  * Simple off-the-shelf models (DM, Poisson, etc.)
  * Low rank models ([this one](https://arxiv.org/abs/1910.11985) and 
    [this one](https://www.ncbi.nlm.nih.gov/pubmed/28991375)
* Criterion: (nested CV) likelihood
* Problem: high-dimensional integration with our model and the low-rank models!
  * $f(c | \theta) = \int f(c|x) f(x|\theta)$
  * $f(c|x)$ is high-dimensional and heavily concentrated around $\hat{x} = \frac{c}{\sum c}$
  
## Strategize about paper 3 vs. CRT paper