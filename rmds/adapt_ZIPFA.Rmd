---
title: "Adapting ZIPFA"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "../")
library(magrittr)
library(ggplot2)
```

```{r load data, include=FALSE}
load("../data/physeqs/genera.RData")
physeq <- physeq_genera %>% 
  phyloseq::subset_samples(dataset_name == "MucosalIBD") %>% 
  smar::prune_taxaSamples(flist_taxa = genefilter::kOverA(k = 5, A = 1))
mat_X_count <- t(smar::otu_table2(physeq))
colnames(mat_X_count) <- CRTmicrobiome:::simplify_feature(colnames(mat_X_count))
mat_X <- t(apply(mat_X_count, 1, function(x) x / sum(x)))
```

# Agenda
* Adapting ZIPFA into a marginal model for counts
* I've outlined a [research statement](https://docs.google.com/document/d/1ioU_ZQFtNI3ibJE8ZLFlQQfjjP0yxqtfUU_6zSO85Os/edit?usp=sharing)
* SparseDOSSA authorship

# The ZIPFA model
\begin{align}
& C_{ij} \sim \text{ZIP distribution} \\
& \text{logit}(p_{ij}) = −\tau \ln(\lambda_{ij}) \\
& \Lambda = U V^{\prime}
\end{align}

* Parameters: $U$, $V$, $\tau$
* Optimization: during iteration $r$
  1. Given $\hat{V}^{(r)}$, fit zero-inflated Poisson regression (with EM), 
     to obtain $\hat{U}^{(r+1)*}$
  2. Given $\hat{U}^{(r)}$, fit zero-inflated Poisson regression (with EM), 
     to obtain $\hat{V}^{(r+1)*}$
  3. Update $\hat{\tau}^{(r + 1)}$ from the fit of 2. Update $\hat{U}^{(r + 1)}$,
     $\hat{V}^{(r + 1)}$ as the SVD of $\hat{U}^{(r+1)*} \hat{V}^{(r+1)* \prime}$
* Need to adapt to form marginal model of $C$
     
# Adapted ZIPFA model
\begin{align}
& C_{ij} \sim \text{ZIP distribution} \\
& \text{logit}(p_{ij}) = −\tau \ln(\lambda_{ij}) \\
& \Lambda = U V^{\prime} \\
& U \sim \text{MVN}(\theta)
\end{align}

* Parameters: $\theta$, $V$, $\tau$
* Optimization: EM. During iteration $r$:
  1. E-step: given $\hat{\theta}^{(r)}$, $\hat{V}^{(r)}$, $\hat{\tau}^{(r)}$, 
     obtain $E U | C$
     * $f(U | C) \propto f(C | U, V, \tau) \times f(U | \theta)$
     * $f(U | \theta)$ by asumption MVN. $f(C | U, V, \tau)$ can be expanded 
       around $\hat{U}^{\text{MLE}}$ into MVN
     * $E U | C$ become weighted average of two MVN means
  2. M-step: plug in $E U | C$, obtain $\hat{\theta}^{(r + 1)}$, 
     $\hat{V}^{(r + 1)}$, $\hat{\tau}^{(r + 1)}$
     * Optimization for $\hat{\tau}^{(r + 1)}$, $\hat{V}^{(r + 1)}$ exactly the
       same as step 2 in the original algorithm!
* $V$ no longer maintains orthonormality

# The MVN assumption on $U$
```{r fit ZIPFA one iteration, evalute U, echo=FALSE}
fit_ZIPFA <- ZIPFA::ZIPFA(X = mat_X_count, k = 3, cut = 1, display = FALSE)
U <- fit_ZIPFA$Ufit[[fit_ZIPFA$itr]]
V <- fit_ZIPFA$Vfit[[fit_ZIPFA$itr]]
colnames(U) <- paste0("loading", seq_len(ncol(U)))
list("loading2", "loading3") %>%
  purrr::map(function(name_y) {
    U %>%
      as.data.frame() %>%
      ggplot(aes(x = loading1, y = !!sym(name_y))) +
      geom_point()
  }) %>%
  cowplot::plot_grid(plotlist = ., nrow = 1)
```
