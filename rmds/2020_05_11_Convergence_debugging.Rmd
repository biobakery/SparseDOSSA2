---
title: "Convergence debugging"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/n/janson_lab/lab/sma/sparsedossa_update/")
knitr::opts_chunk$set(echo=FALSE)
library(magrittr)
library(ggplot2)
```

* Estimation of $\Omega$ converges badly during EM. 
* Examine its input vs. output during the iterations to debug. During one EM step:
    * E step: obtain expectation of "modified" Pearson correlation $P^{*(r)}$
    * M step: 
        * Solve mapping function to obtain original Pearson correlation
          $P^{(r)}_{ij} = f^{-1}(P^{*(r)}_{ij})$
        * Graphical lasso to solve $\Omega^{(r)} = \text{arg} \min 
          \text{tr}(\Omega P^{(r)}) + \lambda ||\Omega||$
* Between two EM iternations, compare $P^{*(r)} \rightarrow P^{(r)} \rightarrow \Omega^{(r)}$

```{r load functions and data, echo=FALSE}
smar::sourceDir("SparseDOSSA2/R/")
load("results/tmp/Simulation_smaller2/2020_05_11/tb_job.RData")
load("results/tmp/Simulation_smaller2/2020_05_11/61/debug_lambda_1.RData")

# input to correlation calculation function
data <- tb_job[61, ]$x_samples[[1]]
lambda <- tb_job[61, ]$lambdas[[1]][1]
fit_marginals <- get_marginals(data)

l_sigma <- l_debug$ll_params[c(29, 30)] %>% purrr::map("sigma")
l_adata <- l_debug$ll_easums[c(29, 30)] %>% 
  purrr::map(~ {
    data * .x[, 1]
  })
l_marginals <- l_sigma %>% 
  purrr::map(~ {
    marginals <- fit_marginals
    marginals$sigma <- .x
    marginals
  })
l_gdata <- l_marginals %>% 
  purrr::map2(
    l_adata, 
    ~ vapply(seq_len(ncol(.y)),
             function(i_feature)
               a_to_g(a = .y[, i_feature],
                      pi0 = .x$pi0[i_feature],
                      mu = .x$mu[i_feature],
                      sigma = .x$sigma[i_feature]),
             rep(0.0, nrow(.y)))
  )
l_corr <- l_gdata %>% purrr::map(cor)
```

```{r parallel computing to get the correlation input}
# l_corr_solve <- list()
# l_corr_solve[[1]] <- 
#   get_s(cor_data = l_corr[[1]],
#         pi0 = l_marginals[[1]]$pi0,
#         glim = l_marginals[[1]]$glim,
#         g0 = l_marginals[[1]]$g0,
#         sigmaMod = l_marginals[[1]]$sigmaMod)
# l_corr_solve[[2]] <- 
#   get_s(cor_data = l_corr[[2]],
#         pi0 = l_marginals[[2]]$pi0,
#         glim = l_marginals[[2]]$glim,
#         g0 = l_marginals[[2]]$g0,
#         sigmaMod = l_marginals[[2]]$sigmaMod)
# save(l_corr_solve, 
#      file = "results/tmp/Simulation_smaller2/2020_05_11/l_corr_solve.RData")
```

```{r plotting}
load("results/tmp/Simulation_smaller2/2020_05_11/l_corr_solve.RData")
plot(l_corr[[1]] %>% lower_tri(),
     l_corr[[2]] %>% lower_tri(),
     main = "P_star",
     xlab = "iter_29",
     ylab = "iter_30")
plot(l_corr_solve[[1]] %>% lower_tri(),
     l_corr_solve[[2]] %>% lower_tri(),
     main = "P",
     xlab = "iter_29",
     ylab = "iter_30")
plot(l_debug$ll_params[[29]]$Omega %>% lower_tri(),
     l_debug$ll_params[[30]]$Omega %>% lower_tri(),
     main = "Omega",
     xlab = "iter_29",
     ylab = "iter_30")
```

* The problem is due to the "near" non-identifiability of $P^* = f(P)$ function:
```{r examine the difference}
feature1 <- 202
feature2 <- 33
corrs_hidden <- seq(-0.99, -0.5, by = 0.01)
corrs_obs <- vapply(corrs_hidden,
                    function(i_corr)
                      Rho2(i_corr, 
                           pi0_1 = fit_marginals$pi0[feature1],
                           pi0_2 = fit_marginals$pi0[feature2], 
                           glim_1 = fit_marginals$glim[feature1],
                           glim_2 = fit_marginals$glim[feature2], 
                           g0_1 = fit_marginals$g0[feature1],
                           g0_2 = fit_marginals$g0[feature2], 
                           sigmaMod_1 = fit_marginals$sigmaMod[feature1],
                           sigmaMod_2 = fit_marginals$sigmaMod[feature2]),
                    0.0)
plot(corrs_hidden, corrs_obs, xlab = "P", ylab = "P_star")
points(l_corr_solve[[1]][feature1, feature2],
      l_corr[[1]][feature1, feature2],
      col = "red", pch = 19)
points(l_corr_solve[[2]][feature1, feature2],
      l_corr[[2]][feature1, feature2],
      col = "red", pch = 19)
```

* Solution: determine convergence based on $P^{*(r)}$, not $P^{(r)}$ or $\Omega^{(r)}$?

* Two additional remarks:
    * Penalization helps with non-identifiability, thus also this issue
    * It can happen that $P^{*}_{\text{obs}} < \min P^{*}$?
        * $P^{*} = \text{E} g(X)$, $g$ is some function of data
        * $P^{*}_{\text{obs}} = \text{E}_{\text{empirical}} g(X)$